<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>Including SS3 assessment within the Management Procedure of FLBEIA</title>

<script src="site_libs/header-attrs-2.1/header-attrs.js"></script>
<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/yeti.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/textmate.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<link href="site_libs/font-awesome-5.1.0/css/all.css" rel="stylesheet" />
<link href="site_libs/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet" />

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>




<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 45px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 50px;
  margin-top: -50px;
}
.section h2 {
  padding-top: 50px;
  margin-top: -50px;
}
.section h3 {
  padding-top: 50px;
  margin-top: -50px;
}
.section h4 {
  padding-top: 50px;
  margin-top: -50px;
}
.section h5 {
  padding-top: 50px;
  margin-top: -50px;
}
.section h6 {
  padding-top: 50px;
  margin-top: -50px;
}
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #ffffff;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html"></a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="http://flr-project.org">
    <span class="fa fa-home"></span>
     
    FLR
  </a>
</li>
<li>
  <a href="index.html">
    <span class="fa fa-info"></span>
     
    Home
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-play-circle-o"></span>
     
    Intro
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="A_quick_introduction_to_FLR.html">A quick introduction to FLR</a>
    </li>
    <li>
      <a href="An_overview_of_the_FLCore_classes.html">An overview of the FLCore classes</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-database"></span>
     
    Input
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="Loading_your_data_into_FLR.html">Loading your data into FLR</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-magic"></span>
     
    Modelling
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="Modelling_stock_recruitment_with_FLSR.html">Modelling stock recruitment with FLSR</a>
    </li>
    <li>
      <a href="Statistical_catch_at_age_models_in_FLa4a.html">Statistical catch at age models in FLa4a</a>
    </li>
    <li>
      <a href="Modelling_growth_and_its_uncertainty_in_FLa4a.html">Modelling growth and its uncertainty in FLa4a</a>
    </li>
    <li>
      <a href="Natural_mortality_modelling_in_FLa4a.html">Natural mortality modelling in FLa4a</a>
    </li>
    <li>
      <a href="Stock_assessment_using_eXtended_Survivors_Analysis_with_FLXSA.html">Stock assessment using eXtended Survivors Analysis with FLXSA</a>
    </li>
    <li>
      <a href="Using_information_on_life_history_relationships.html">Using information on Life History relationships</a>
    </li>
    <li>
      <a href="Life_history_relationships.html">Life history relationships</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-tachometer"></span>
     
    Advice
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="Running_Medium_Term_Forecasts_with_FLash.html">Running Medium Term Forecasts with FLash</a>
    </li>
    <li>
      <a href="Short_Term_Forecasting_for_advice_using_FLash.html">Short Term Forecasting for advice using FLash</a>
    </li>
    <li>
      <a href="Forecasting_on_the_Medium_Term_for_advice_using_FLasher.html">Forecasting on the Medium Term for advice using FLasher</a>
    </li>
    <li>
      <a href="Reference_points_for_fisheries_management_with_FLBRP.html">Reference points for fisheries management with FLBRP</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-cogs"></span>
     
    MSE
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="An_introduction_to_MSE_using_FLR.html">An introduction to MSE using FLR</a>
    </li>
    <li>
      <a href="Management_procedure_biomass_dynamic.html">Biomass Dynamic Management Procedures</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-cogs"></span>
     
    FLBEIA
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="An_introduction_to_MSE_using_FLR.html">An introduction to MSE using FLR</a>
    </li>
    <li>
      <a href="FLBEIA_Conditioning.html">Conditioning FLBEIA using Smart Conditioning Functions</a>
    </li>
    <li>
      <a href="FLBEIA_A_Simple_Example.html">A simple example on how to use FLBEIA</a>
    </li>
    <li>
      <a href="FLBEIA_An_Example_with_multiple_dimensions.html">A simple example with multiple dimensions in FLBEIA</a>
    </li>
    <li>
      <a href="FLBEIA_Checking_inputs.html">Checking FLBEIA inputs</a>
    </li>
    <li>
      <a href="FLBEIA_Using_Assessment_models_in_the_MP.html">Using Stock Assessment models in the Management procedure of FLBEIA</a>
    </li>
    <li>
      <a href="FLBEIA_Incorporating_SS3assessment_MP.html">Including SS3 assessment within the Management Procedure of FLBEIA</a>
    </li>
    <li>
      <a href="FLBEIA_Testing_Management_Strategies.html">Testing different Management Strategies in FLBEIA</a>
    </li>
    <li>
      <a href="FLBEIA_Data_Poor_MSE.html">Data Limited MSE in FLBEIA</a>
    </li>
    <li>
      <a href="FLBEIA_Smart_Conditioning_II.html">Smart Conditioning II</a>
    </li>
    <li>
      <a href="FLBEIA_Mixed_Fisheries_Tutorial.html">ICES Mixed Fisheries Advice using FLBEIA</a>
    </li>
    <li>
      <a href="FLBEIA_Bio_Economic_Tutorial.html">Bio-Economic simulation using FLBEIA</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-area-chart"></span>
     
    Plotting
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="ggplotFL_plotting_FLR_objects_with_ggplot2.html">ggplotFL, plotting FLR objects with ggplot2</a>
    </li>
    <li>
      <a href="Plotting_FLR_objects_using_lattice.html">Plotting FLR objects using lattice</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-puzzle-piece"></span>
     
    Internals
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="Units_of_measurement_in_FLR_objects.html">Units of measurement in FLR objects</a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="http://github.com/flr/doc/issues">
    <span class="fa fa-question fa-lg"></span>
     
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Including SS3 assessment within the Management Procedure of FLBEIA</h1>
<h4 class="date">27 mayo, 2020</h4>

</div>


<p><img src="images/FLBEIA_logo.png" width="20%" style="display: block; margin: auto;" /></p>
<div id="aim" class="section level1">
<h1>Aim</h1>
<p><strong>FLBEIA</strong> <span class="citation">(Garcia et al. 2017)</span> provides a battery of tutorials for learning how to use this software. This <!-- is the thirth   --> tutorial <!-- of **FLBEIA** and it --> is a practical guide about how to use Stock Synthesis (SS3) <span class="citation">(Methot and Wetzel 2013)</span> assessment model to assess the stock status within <strong>FLBEIA</strong> in the Management Procedure (MP).</p>
<p>In this tutorial it is presented an example on how to include SS3 within the MP to assess a stock. It has to be stated that this is an example for a particular stock and in case of aiming to use it for other stock this should only serve as a guide, because some of the functions are case specific. This will be detailed along the tutorial.</p>
</div>
<div id="required-packages-to-run-this-tutorial" class="section level1">
<h1>Required packages to run this tutorial</h1>
<p>To follow this tutorial you should have installed the following packages:</p>
<ul>
<li>FLR: <a href="http://www.flr-project.org/FLCore/">FLCore</a> and <a href="http://www.flr-project.org/FLFleet/">FLFleet</a>.</li>
<li>Stock Synthesis: <a href="https://cran.r-project.org/web/packages/r4ss/index.html">r4ss</a>.</li>
<li>Data manipulation: <a href="https://cran.r-project.org/web/packages/arrayhelpers/index.html">arrayhelpers</a>, <a href="https://cran.r-project.org/web/packages/reshape2/index.html">reshape2</a>, <a href="https://cran.r-project.org/web/packages/dplyr/index.html">dplyr</a> and <a href="https://cran.r-project.org/web/packages/tidyr/index.html">tidyr</a>.</li>
</ul>
<pre class="r"><code>install.packages( c(&quot;FLCore&quot;, &quot;FLFleet&quot;, &quot;FLBEIA&quot;), 
                  repos=&quot;http://flr-project.org/R&quot;)
install.packages(c(&quot;r4ss&quot;,&quot;reshape2&quot;,&quot;arrayhelpers&quot;,&quot;dplyr&quot;,&quot;tidyr&quot;))</code></pre>
<p>It has to be noted that packages <code>FLCore</code>, <code>FLFleet</code> and <code>FLBEIA</code> have to be installed in this exact order, as alternative orders can cause some problems.</p>
<p>Load all thenecessary packages.</p>
<pre class="r"><code>library(FLBEIA)
library(r4ss)
library(reshape2)
library(arrayhelpers)
library(tidyr)
library(dplyr)</code></pre>
</div>
<div id="loading-your-data" class="section level1">
<h1>Loading your data</h1>
<p>The first step is to condition the Operating Model and the Management Procedure with all the relevant information.</p>
<p>In this example, we will take most of the objects required to run the MSE from an <code>.RData</code> file and we will exclusively focus on the observation and assessment part.</p>
<p>For this case, the Operating Model (OM) runs annually and it is formed by a single age-structured stock, the <a href="http://www.ices.dk/sites/pub/Publication%20Reports/Advice/2018/2018/pil.27.8c9a.pdf">Iberian sardine</a> (<em>Sardina pilchardus</em>, ICES pil.27.8c9a) and an unique fleet which activity is performed in an unique metier (i.e. not differing among the different fleets and metiers targeting the stock).</p>
<p>The file is downloaded into a temporary folder, and uncompressed. Simply change the value of <code>dir</code> to save the file in another folder.</p>
<!-- ```{r, getfilesLocal, message=FALSE} -->
<!-- dir <- "src" -->
<!-- ``` -->
<pre class="r"><code>dir &lt;- tempdir()
# download.file(&quot;http://www.flr-project.org/doc/src/ibPIL.zip&quot;, file.path(dir, &quot;ibPIL.zip&quot;))
# unzip(file.path(dir, &quot;ibPIL.zip&quot;), exdir=dir)
unzip(&quot;src/ibPIL.zip&quot;, exdir=dir)</code></pre>
<p>The FLBEIA input data can now be loaded using <code>load</code>:</p>
<pre class="r"><code>load(file.path(dir, &quot;ibPIL.RData&quot;))
ls()</code></pre>
<pre><code>##  [1] &quot;advice&quot;      &quot;advice.ctrl&quot; &quot;biols&quot;      
##  [4] &quot;biols.ctrl&quot;  &quot;covars&quot;      &quot;covars.ctrl&quot;
##  [7] &quot;dir&quot;         &quot;fleets&quot;      &quot;fleets.ctrl&quot;
## [10] &quot;indices&quot;     &quot;main.ctrl&quot;   &quot;obs.ctrl&quot;   
## [13] &quot;PIL_ref.pts&quot; &quot;SRs&quot;</code></pre>
<p>This data file contains information to condition FLBEIA. Specifically, it contains all the elements to run FLBEIA, except from <code>obs.ctrl</code> and <code>assess.ctrl</code> arguments that will be defined in this tutorial.</p>
<p>The Operating Model (OM) is conditioned with the information from the last stock assessment available <span class="citation">(ICES 2018)</span>. The population is age-structured (ages 0 to 6+) and exploited by an unique fleet (composed by one metier) and is moved forward in anual steps. It is assumed that the fleet fully complies with the catch advice and this behaviour is obtained using the <code>SMFB</code> function (for details, see information on <code>SMFB</code> function in the <a href="https://github.com/flr/FLBEIA/blob/master/vignettes/FLBEIA_manual.pdf"><strong>FLBEIA</strong> manual</a>).</p>
<p>In the Management Procedure (MP), the stock is observed without error, and the stock is assessed with SS3, version 3.24f <span class="citation">(Methot 2012)</span>. The yearly catch advice (the TAC) is obtained using the HCR used by ICES in the MSY framework for data rich stocks <span class="citation">(ICES 2009)</span>.</p>
<p>The objects used have 1 iteration and uncertainty in the projection comes exclusively from the generation of the new incoming recruitments.</p>
<ul>
<li>Operating model
<ul>
<li>Biological:
<ul>
<li>Population dynamics: <code>PIL</code> - age structured population growth</li>
<li>SR model: <code>PIL</code> - Beverthon and Holt (segmented regression)</li>
</ul></li>
<li>Fleet: <code>INT</code> - Simple Mixed Fisheries Behaviour</li>
<li>Covariates: no covariates</li>
</ul></li>
<li>Management Procedure
<ul>
<li>Observation: <code>PIL</code> - observation of biological and catch information</li>
<li>Assessment: <code>PIL</code> - SS3 assessment</li>
<li>Management advice: <code>PIL</code> - ICES harvest control rule</li>
</ul></li>
</ul>
<pre class="r"><code># Projection years
main.ctrl

# Stock: one stock named as PIL with an age-structured population growth
#        - recruitment: generated by a Beverton-Holt model fitted to historical data
summary(biols)
biols.ctrl
summary(SRs)
SRs$PIL@model
SRs$PIL@params
SRs$PIL@uncertainty

# Fleet: one unique fleet (INT), with one unique metier (ALL), targeting only sardine (PIL)
#        - effort dynamics: simple mixed fisheries bechaviour
#        - catch model    : Cobb Douglas at age
#        - capital model  : fixed capital
#        - price model    : fixed price
summary(fleets)
summary(fleets$INT@metiers)
summary(fleets$INT@metiers$ALL@catches)
fleets.ctrl

# Covariates: no covariates
covars
covars.ctrl

# Advice: TAC given by ICES HCR
summary(advice)
advice.ctrl


# Indices: two indices available
#          - AcousticNumberAtAge: numbers at age
#          - DEPM               : total biomass every 3 years 
summary(indices)
indices$AcousticNumberAtAge@index
indices$AcousticNumberAtAge@index.q
indices$DEPM@index
indices$DEPM@index.q</code></pre>
</div>
<div id="ss3-assessment" class="section level1">
<h1>SS3 assessment</h1>
<!-- For details on the Iberian sardine assessment see Stock annex and WGHANSA 2018 report. -->
<p>The sardine assessment is an age-based assessment assuming a single area, a single fishery, a yearly season and genders combined. Input data include catch (in biomass), age composition of the catch, total abundance (in numbers) and age composition from an annual acoustic survey and spawning stock biomass (SSB) from a triennial DEPM survey. Considering the current assessment calendar (annual assessment WG in November) in year (y), the assessment includes fishery data up to year y-1 and acoustic data up to year y. The reference assessment used was the one from the last assessment year <span class="citation">(ICES 2018)</span>. For more details, see <span class="citation">(ICES 2019)</span>.</p>
<ul>
<li><p>The model estimates population biomass in the beginning of the last assessment year (interim year). There are data from the acoustic survey but not from the fishery (catch and age composition) for the interim year. Data used for the interim year are the following: stock weights-at-age, catch biomass and catch weights-at-age are equal to those assumed for short-term predictions.</p></li>
<li><p>The fishery age composition in the interim year is assumed to be equal to that in the previous year. The fishery age composition is included in the calculation of expected values but excluded from the objective function. Recruitment in the interim year is derived from the stock-recruitment relationship.</p></li>
<li><p>The model estimates spawning stock biomass (SSB) and adult biomass (B1+, biomass of age 1 and older) at the beginning of the year. The reference age range for output fishing mortality is 2-5.</p></li>
</ul>
<p>For more details on the Iberian sardine stock assessment see the <a href="http://www.ices.dk/sites/pub/Publication%20Reports/Stock%20Annexes/2017/pil.27.8c9a_SA.pdf">ICES Stock Annex</a>.</p>
<p>To include the SS3 stock assessment model within the MSE simulations running in FLBEIA, we need to create an specifice function that mimics the stock asssessment. This function will update values for every assessment cycle. Such function is not available in the FLBEIA library, as it should be case-specific. Therefore, the function presented here is an example and it should be readapted if it wants to be used for another stock.</p>
<p>We will name the function as <code>ss32flbeia</code>. As inputs, the function needs the ‘observed’ stock and indices objects (surveys) as well as a folder with the reference assessment in SS3 (in this case is exactly the one used to condition the operating model for MSE). This folder is available in the ibPIL.zip file, so it has been already uncompressed in the <code>temp</code> folder (see “./ss3R”). Firstly, you need to choose the appropiate ss3 executable and call it SS3.exe (in the assess_ref folder there are three different options: ss3_win.exe, ss3_linux.exe, ss3_ios.exe).</p>
<p>Within the FLBEIA MSE process, for each projection year, the <code>ss32flbeia</code> function works as follows:</p>
<ul>
<li><p>Copies the reference assessment folder (containing all files needed to run ss3)</p></li>
<li><p>Reads the <code>ss3.dat</code>, <code>wtatage</code> and <code>.ctl</code> files</p></li>
<li><p>Sets <span class="math inline">\(10^{-5}\)</span> value for very low observed catches (i.e. when <code>stock@catch</code> <span class="math inline">\(&lt;10^{-5}\)</span>)</p></li>
<li><p>Reads the catch and the indices values from the FLR objects</p></li>
<li><p>Eliminates catch at age for years where catch is very low (<span class="math inline">\(&lt;10^{-4}\)</span>)</p></li>
<li><p>Creates new <code>.dat</code>, <code>wtatage</code> and <code>.ctl</code> files based on the reference <code>.dat</code>, <code>wtatage</code> and <code>.ctl</code> files with new catch and indices values from FLR objects</p></li>
<li><p>Runs <code>ss3.exe</code> executable</p></li>
<li><p>Reads ss3 output files using the <code>r4ss</code> package</p></li>
<li><p>Updates <code>stock@harvest</code> and <code>stock@stock.n</code> slots with SS3 output</p></li>
<li><p>Saves convergence indicator, recruitment, fbar, SSB, catchabilities and selectivities from SS3 runs in the covars component of the OM.</p></li>
<li><p>Deletes the copied folder after running each realization.</p></li>
</ul>
<p>Therefore we translate this into R code:</p>
<pre class="r"><code>#########################################################
#### Function to read from FLstock object,
#### create SS3 files (from existing reference ones),
#### run ss3 assessment with new data, and
#### update FLR stock object with estimates from SS3.
#########################################################

########################################################
### Leire Citores september-october 2018 ###############
########################################################

ss32flbeia &lt;- function(stock,indices,control,covars=covars){
  
  # save iteration number
  runi &lt;- control$run_it
  
  # last year of the new stock object
  lasty &lt;- range(stock)[&quot;maxyear&quot;]
  
  # To avoid problems in SS3:
  # if catch &lt; 10^-5 --&gt; small value to total catch, 
  # remove catch at age (done some lines later),
  # and put the wt from year before. 
  stock@catch.wt[,which(is.na(stock@catch.wt[2,]))] &lt;- stock@catch.wt[,ac(lasty-1)] 
  
  stock@catch &lt;- computeCatch(stock)
  stock@catch[,which(stock@catch&lt;10^-5)] &lt;- 10^-5
  
  # print
  cat(&quot;catches in it&quot;, runi, range(stock)[&quot;maxyear&quot;], &quot;\n&quot;, 
      stock@catch[,ac(range(stock)[&quot;maxyear&quot;])], &quot;\n&quot;)
  
  # ref_name: reference ss3 assessment folder name
  ref_name &lt;- control$ref_name
  
  # directory where the folder with the reference ss3 assessment is located
  assess_dir &lt;- control$assess_dir
  
  # get current working directory
  dir0 &lt;- getwd()
  
  # set the new working directory
  setwd(assess_dir)
  
  # create a new folder where the new assessment will be run
  dir &lt;- paste0(&quot;assess_temp&quot;, runi, lasty)
  dir.create(dir)
  
  # copy the reference assessment folder  into the new folder
  file.copy(ref_name, dir, recursive = TRUE)

  # set the working directory inside this folder
  # (at the end of the assessment this new folder will be deleted,
  #  but the reference assessment is always kept)
  temp_dir &lt;- paste0(dir,paste0(&quot;/&quot;,ref_name))
  setwd(temp_dir)
  
  
  ################################################################
  #### read data from new FLR objects and write to SS3 files
  #################################################################

  # last year of the new stock object
  lasty &lt;- range(stock)[&quot;maxyear&quot;]

  # read reference assessment data file
  datss &lt;- SS_readdat(&quot;sardine.dat&quot;, verbose= FALSE, version = 3.24)

  ##control file
  ctl &lt;- readLines(&quot;sardine.ctl&quot;)

  # natural mortality vector
  ctl[27] &lt;- paste(m(stock)[,1],collapse=&quot; &quot;)
  # - update the year in the control file (from reference assessment year to actual year)
  ctl_new &lt;- gsub(pattern = ac(datss$endyr), replace = ac(lasty), x = ctl)
  # - update the year recruitmen devs (assessment year-1)
  ctl_new &lt;- gsub(pattern = ac(datss$endyr-1), replace = ac(lasty-1), x = ctl_new)
  # - write the new control file, it overwrites the old one
  writeLines(ctl_new, con=&quot;sardine.ctl&quot;)
  
  # total catch
  catch &lt;- melt(catch(stock)[,])[,c(&quot;value&quot;,&quot;year&quot;)]
  catch$seas &lt;- 1
  colnames(catch) &lt;- colnames(datss$catch)
  datss$catch &lt;- catch

  # age structured catch and index
  
  catchn &lt;- dcast(na.omit(melt(catch.n(stock)[,])[,c(&quot;value&quot;,&quot;year&quot;,&quot;age&quot;)]),year~age)
  catchn &lt;- cbind(catchn[,1],subset(datss$agecomp,FltSvy==1)[1,2:9],catchn[,-1])
  lastrow &lt;- dim(catchn)[1]
  # no catch at age for the last year available (--&gt; delete this value)
  catchn &lt;- catchn[-lastrow,]
  # remove catch at age when catch&lt;10^-4
  catch0years &lt;- which(catchn[,ac(4)]&lt;10^-4)
  if(length(catch0years)&gt;0)
    catchn &lt;- catchn[-catch0years,]
  # set manullay sample size for catch.n for years &gt; 1990
  # sample size = 50 for year &lt;= 1990
  # sample size = 75 for year &gt; 1990
  # (see Iberian sardine Stock Annex for details)
  catchn[,&quot;Nsamp&quot;][catchn[,1]&gt;1990] &lt;- 75 
  
  indexn &lt;- dcast(na.omit(melt(indices[[1]]@index[,])[,c(&quot;value&quot;,&quot;year&quot;,&quot;age&quot;)]),year~age)
  indexn &lt;- cbind(indexn[,1],subset(datss$agecomp,FltSvy==2)[1,2:9],indexn[,-1])
  colnames(indexn) &lt;- colnames(catchn)&lt;-colnames(datss$agecomp)
  agecomp &lt;- rbind(catchn,indexn)
  datss$agecomp &lt;- agecomp

  # biomass indices
  
  index2  &lt;- cbind(indexn[,1],rowSums(indexn[,c(10:16)]))
  se_log2 &lt;- subset(datss$CPUE,index==2)$se_log
  index2  &lt;- cbind(year=index2[,1],seas=1,index=2,obs=index2[,2],se_log=mean(se_log2))

  index3  &lt;- na.omit(melt(indices[[2]]@index[,])[,c(&quot;value&quot;,&quot;year&quot;)])
  se_log3 &lt;- subset(datss$CPUE,index==3)$se_log[1]
  index3  &lt;- cbind(year=index3$year,seas=1,index=3,obs=index3$value,se_log=se_log3)

  datss$CPUE &lt;- as.data.frame(rbind(index2,index3))

  ################################################################################

  #number of lines
  datss$styr  &lt;- min(catch$year)
  datss$endyr &lt;- an(lasty)
  datss$N_catch   &lt;- dim(datss$catch)[1]
  datss$N_cpue    &lt;- dim(datss$CPUE)[1]
  datss$N_agecomp &lt;- dim(datss$agecomp)[1]

  #write the new data file, it overwrites the old one
  SS_writedat(datss,&quot;sardine.dat&quot;, overwrite = TRUE, verbose = FALSE, version = &quot;3.24&quot;)
  
  ##wtatage file
  #stock weight (fleet=0)
  stockwt &lt;- t(stock.wt(stock)[,,drop=TRUE])
  stockwt &lt;- cbind(rownames(stockwt),1,1,1,1,0,stockwt)
  stockwt &lt;- apply(stockwt,1,function(x){paste(x,collapse=&quot;\t&quot;)})
  names(stockwt) &lt;- NULL

  # weigth for age structured acoustic index (fleet=2) (same as stock weight)
  index2wt &lt;- t(stock.wt(stock)[,,drop=TRUE])
  index2wt &lt;- cbind(rownames(index2wt),1,1,1,1,2,index2wt)
  index2wt &lt;- apply(index2wt,1,function(x){paste(x,collapse=&quot;\t&quot;)})
  names(index2wt) &lt;- NULL

  # catch weight (fleet 1 and -1)
  catchwt &lt;- t(catch.wt(stock)[,,drop=TRUE])
  catchwt &lt;- cbind(rownames(catchwt),1,1,1,1,1,catchwt)
  catchwt &lt;- apply(catchwt,1,function(x){paste(x,collapse=&quot;\t&quot;)})
  names(catchwt) &lt;- NULL

  catchwt_1 &lt;- t(catch.wt(stock)[,,drop=TRUE])
  catchwt_1 &lt;- cbind(rownames(catchwt_1),1,1,1,1,-1,catchwt_1)
  catchwt_1 &lt;- apply(catchwt_1,1,function(x){paste(x,collapse=&quot;\t&quot;)})
  names(catchwt_1) &lt;- NULL

  # maturity (fleet=-2)
  mat &lt;- t((mat(stock)*stock.wt(stock))[,,drop=TRUE])
  mat &lt;- cbind(rownames(mat),1,1,1,1,-2,mat)
  mat &lt;- apply(mat,1,function(x){paste(x,collapse=&quot;\t&quot;)})
  names(mat) &lt;- NULL

  # read the reference weight file
  wta &lt;- readLines(&quot;wtatage.ss&quot;)[1:7]
  # generate the new weigth matrix with the data from FLR objects
  wta_new &lt;- c(wta,stockwt,catchwt,mat,catchwt_1,index2wt)
  # update number of lines
  wta_new[1] &lt;- ac(length(wta_new)-length(wta))
  # write the new weight file, it overwrtites the old one
  writeLines(wta_new, con=&quot;wtatage.ss&quot;)
  
  
  ################################################################
  ##                        execute SS3
  ## (be careful to use the adecuate executable depending on the
  ##  operating system -windows, linux or ios-)
  ################################################################

  system(&#39;./SS3.exe&#39;)
  
  #####################################################
  ### S3 output back to FLR. Just harvest and stock:
  #####################################################

  dir.assess &lt;- paste0(getwd(),&quot;&quot;)
  assess  &lt;- SS_output(dir = dir.assess, forecast = FALSE, printstats = FALSE, verbose = FALSE)
  maxyear &lt;- assess$endyr
  ages    &lt;- assess$agebins
  years   &lt;- assess$startyr:assess$endyr
  
  #------------------------------------
  # extract assessment outputs:
  # F-AT-AGE, REFERENCE F
  #
  # we need to calculate F-at-age from apical F 
  # (i.e. F on the fully selected age) and 
  # selectivity at age
  #------------------------------------
  
  selectivity &lt;- subset(assess$ageselex, Fleet==1 &amp; Factor==&quot;Asel2&quot; &amp; Yr %in% years, 
                        select=c(&quot;Yr&quot;, ac(ages)))

  idx &lt;- grep(&quot;F_&quot;, assess$derived_quants$Label)
  f.apical &lt;- data.frame(f=assess$derived_quants[idx,&quot;Value&quot;])
  f.apical$Yr &lt;- years

  f.apsel &lt;- merge(f.apical, selectivity, all.x = TRUE, by=&quot;Yr&quot;)

  f &lt;- f.apsel$f * f.apsel[,ac(ages)]

  harvest &lt;- FLQuant(unname(as.matrix(t(f))),quant=&quot;age&quot;,units=&quot;f&quot;, 
                     dimnames=list(age=ac(ages), year=ac(years)))
  
  #------------------------------------
  # extract assessment outputs:
  # NUMBERS-AT-AGE
  #------------------------------------
  
  natage &lt;- subset(assess$natage, Era==&quot;TIME&quot; &amp; `Beg/Mid`==&quot;B&quot; , select=ac(ages))

  stock.n &lt;- FLQuant(unname(as.matrix(t(natage))), quant=&#39;age&#39;, units=&#39;NA&#39;,
                     dimnames=list(age=ac(ages), year=ac(years)))
  
  # update stock object
  harvest(stock) &lt;- harvest
  stock.n(stock) &lt;- stock.n
  stock(stock)   &lt;- computeStock(stock)
  
  
  # fill covars to see retros
  covars$ssb[ac(lasty),ac(years)]  &lt;- ssb(stock)[,]
  covars$rec[ac(lasty),ac(years)]  &lt;- rec(stock)[,]
  covars$fbar[ac(lasty),ac(years)] &lt;- fbar(stock)[,]

  params &lt;- assess$parameters
  q2 &lt;- exp(subset(params,Label==&quot;LnQ_base_2_Acoustic_survey&quot;)[,&quot;Value&quot;])
  q3 &lt;- exp(subset(params,Label==&quot;LnQ_base_3_DEPM_survey&quot;)[,&quot;Value&quot;])
  covars$qs[1,ac(lasty)] &lt;- q2
  covars$qs[2,ac(lasty)] &lt;- q3

  # Three selectivity periods - breakpoints at 1986 &amp; 2004
  # (see Iberian sardine Stock Annex for details)
  covars$sel[,ac(lasty),3,,,] &lt;- as.numeric(subset(selectivity,Yr==lasty)[1,-1])
  covars$sel[,ac(lasty),2,,,] &lt;- as.numeric(subset(selectivity,Yr==2004)[1,-1]) 
  covars$sel[,ac(lasty),1,,,] &lt;- as.numeric(subset(selectivity,Yr==1986)[1,-1])
  
  
  # CONVERGENCE
  
  covars$conv[,ac(lasty)]     &lt;- assess$maximum_gradient_component
  
  #######################
  ### delete files
  #######################
  
  setwd(assess_dir)
  unlink(paste0(assess_dir,dir),recursive=TRUE)
  
  #return to the original working directory
  setwd(dir0)

  return(list(stock = stock,covars=covars))
}</code></pre>
<pre><code>## &lt;environment: R_GlobalEnv&gt;</code></pre>
<p>Now we need to define the <code>assess.ctrl</code> object to call to this new defined function, and we will additionally set some extra control arguments required by this function:</p>
<ul>
<li><p><code>ref_name</code> : the directory where the assessment files for each new year will be stored;</p></li>
<li><p><code>assess_dir</code>: the directory where the assessment files are stored (in this case the full path must be provided); and</p></li>
<li><p><code>run_it</code> : an identifier for the scenario and iteration to avoid overwriting the files when running different iterations and scenarios at the same time (it is optional, but highly recommended when working with several runs at the same time in a computer).</p></li>
</ul>
<p>For this stock, as it occurs for many small pelagics, the stock is observed and assessed up to the assessment year. This should be indicated in the control object also.</p>
<pre class="r"><code>assess.ctrl &lt;- list( PIL = list())

# Assessment model
assess.ctrl$PIL$assess.model &lt;- &quot;ss32flbeia&quot;

# Does the assessment model work with iterations?
assess.ctrl$PIL$work_w_Iter &lt;- FALSE

# Units for fishing mortality: f or hr
assess.ctrl$PIL$harvest.units &lt;- &quot;f&quot;

# Assesment control arguments
sc &lt;- &quot;s0&quot;; it &lt;- 1
assess.ctrl$PIL$control &lt;- list( ref_name = &quot;assess_ref&quot;, 
                                 assess_dir =  file.path(dir,&quot;ss3R/&quot;),
                                 run_it = paste(it,&quot;_sc&quot;,sc,sep=&quot;&quot;))

# Assess output also for assessment year
assess.ctrl$PIL$ass.curryr &lt;- TRUE</code></pre>
<p>We will also initialize the covars object to store there some information on the assessment outputs, in order to be able to track the assessment performance all along the projection period.</p>
<pre class="r"><code>ages      &lt;- dimnames(biols[[1]]@n)$age
yrs       &lt;- dimnames(biols[[1]]@n)$year
proj.yrs  &lt;- ac(main.ctrl$sim.years[1]:main.ctrl$sim.years[2])
assini.yr &lt;- ac(main.ctrl$sim.years[1]-1)

# Assessment estimates:
covars$ssb &lt;- covars$fbar &lt;- covars$rec &lt;- 
  FLQuant(NA, dimnames=list(assess.year=c(assini.yr,proj.yrs), year=yrs))

# - ssb
covars$ssb[assini.yr,] &lt;- ssb(biols$PIL)[,]

# - recruitment
covars$rec[assini.yr,] &lt;- (biols$PIL@n)[1,]

# - survey catchabilities
covars$qs &lt;- FLQuant(NA, dimnames = list(qs=c(&quot;acoustic&quot;,&quot;depm&quot;), year=yrs))

# - selectivity at age
covars$sel &lt;- FLQuant(NA, dimnames = list(age=ages, year=yrs,unit=1:3))

# Assessment convergence
covars$conv &lt;- FLQuant(NA, dimnames = list(conv=&quot;conv&quot;,year=yrs))</code></pre>
</div>
<div id="observation-model" class="section level1">
<h1>Observation model</h1>
<p>For this assessment we need to observe the biological and catch information. Therefore, we need to use <code>age2ageDat</code> function (for details in observation functions see tutorial on <a href="http://www.flr-project.org/doc/Using_Assessment_models_in_the_MP_FLBEIA.html">Using different Assessment models in the Management Procedure of FLBEIA</a>).</p>
<p>Additionally, we also need to observe the two indices available for the stock: a yearly index in numbers at age (named AcousticNumberAtAge) and a 3-yearly biomass index (named DEPM).</p>
<p>For creating the <code>obs.ctrl</code> object we will use the specific creator function (<code>create.obs.ctrl</code>). As default, if not provided as an input, it considers no observation errors (i.e. values equal to 1). For details on how to set observation errors to alternative values see tutorial on <a href="http://www.flr-project.org/doc/Using_Assessment_models_in_the_MP_FLBEIA.html">Using different Assessment models in the Management Procedure of FLBEIA</a>).</p>
<pre class="r"><code>?create.obs.ctrl</code></pre>
<pre class="r"><code>flq.PIL &lt;- FLQuant(dimnames = dimnames(biols$PIL@n)) </code></pre>
<pre><code>## &lt;environment: R_GlobalEnv&gt;</code></pre>
<pre class="r"><code>obs.ctrl &lt;- create.obs.ctrl( stksnames = &quot;PIL&quot;, n.stks.inds = 2, 
                             stks.indsnames = names(indices$PIL),
                             stkObs.models = &quot;age2ageDat&quot;, 
                             indObs.models = c(&quot;ageInd&quot;, &quot;bioInd&quot;), 
                             flq.PIL = flq.PIL)

# Required observation also for assessment year
obs.ctrl$PIL$obs.curryr &lt;- TRUE</code></pre>
</div>
<div id="run-flbeia" class="section level1">
<h1>Run FLBEIA</h1>
<pre class="r"><code>s0 &lt;- FLBEIA( biols = biols, SRs = SRs, BDs = NULL, fleets = fleets,
              covars = covars, indices = indices, advice = advice,
              main.ctrl = main.ctrl, biols.ctrl = biols.ctrl, fleets.ctrl = fleets.ctrl,
              covars.ctrl = covars.ctrl, obs.ctrl = obs.ctrl,
              assess.ctrl = assess.ctrl, advice.ctrl = advice.ctrl)</code></pre>
<pre><code>## ############################################################
## -                   Year:  41 , Season:  1 
## ############################################################
## ************ OPERATING MODEL***************************
## ------------ BIOLOGICAL OM ------------
## -----------------ASPG-----------
## ------------ FLEETS OM ------------
## [1] &quot;~~~~~~~~~~ EFFORT ~~~~~~~~&quot;
## [1] &quot;INT&quot;
## [1] &quot;~~~~~~ UPDATE CATCH ~~~~~~&quot;
## [1] &quot;~~~~~~~~~~ PRICE ~~~~~~~~~~&quot;
## [1] &quot;INT&quot;
## [1] &quot;****************************** CAPITAL ******************************&quot;
## [1] &quot;INT&quot;
## ------------ COVARS OM ------------
## ************ MANAGEMENT PROCEDURE ****************************
## ----------- OBSERVATION MODEL ------------
## ------------ ASSESSMENT MODEL ------------
## catches in it 1_scs0 2018 
##  14060 
## !warning: Report.sso appears to be early version from before Hessian was estimated.
##           equilibrium yield estimates not included in output.
## ----------------- ADVICE -----------------
## -----------------  PIL  -----------------
## [1] 0
## ############################################################
## -                   Year:  42 , Season:  1 
## ############################################################
## ************ OPERATING MODEL***************************
## ------------ BIOLOGICAL OM ------------
## -----------------ASPG-----------
## ------------ FLEETS OM ------------
## [1] &quot;~~~~~~~~~~ EFFORT ~~~~~~~~&quot;
## [1] &quot;INT&quot;
## [1] &quot;~~~~~~ UPDATE CATCH ~~~~~~&quot;
## [1] &quot;~~~~~~~~~~ PRICE ~~~~~~~~~~&quot;
## [1] &quot;INT&quot;
## [1] &quot;****************************** CAPITAL ******************************&quot;
## [1] &quot;INT&quot;
## ------------ COVARS OM ------------
## ************ MANAGEMENT PROCEDURE ****************************
## ----------- OBSERVATION MODEL ------------
## ------------ ASSESSMENT MODEL ------------
## catches in it 1_scs0 2019 
##  1e-05 
## !warning: Report.sso appears to be early version from before Hessian was estimated.
##           equilibrium yield estimates not included in output.
## ----------------- ADVICE -----------------
## -----------------  PIL  -----------------
## [1] 0
## ############################################################
## -                   Year:  43 , Season:  1 
## ############################################################
## ************ OPERATING MODEL***************************
## ------------ BIOLOGICAL OM ------------
## -----------------ASPG-----------
## ------------ FLEETS OM ------------
## [1] &quot;~~~~~~~~~~ EFFORT ~~~~~~~~&quot;
## [1] &quot;INT&quot;
## [1] &quot;~~~~~~ UPDATE CATCH ~~~~~~&quot;
## [1] &quot;~~~~~~~~~~ PRICE ~~~~~~~~~~&quot;
## [1] &quot;INT&quot;
## [1] &quot;****************************** CAPITAL ******************************&quot;
## [1] &quot;INT&quot;
## ------------ COVARS OM ------------
## ************ MANAGEMENT PROCEDURE ****************************
## ----------- OBSERVATION MODEL ------------
## ------------ ASSESSMENT MODEL ------------
## catches in it 1_scs0 2020 
##  1e-05 
## !warning: Report.sso appears to be early version from before Hessian was estimated.
##           equilibrium yield estimates not included in output.
## ----------------- ADVICE -----------------
## -----------------  PIL  -----------------
## [1] 0
## ############################################################
## -                   Year:  44 , Season:  1 
## ############################################################
## ************ OPERATING MODEL***************************
## ------------ BIOLOGICAL OM ------------
## -----------------ASPG-----------
## ------------ FLEETS OM ------------
## [1] &quot;~~~~~~~~~~ EFFORT ~~~~~~~~&quot;
## [1] &quot;INT&quot;
## [1] &quot;~~~~~~ UPDATE CATCH ~~~~~~&quot;
## [1] &quot;~~~~~~~~~~ PRICE ~~~~~~~~~~&quot;
## [1] &quot;INT&quot;
## [1] &quot;****************************** CAPITAL ******************************&quot;
## [1] &quot;INT&quot;
## ------------ COVARS OM ------------
## ************ MANAGEMENT PROCEDURE ****************************
## ----------- OBSERVATION MODEL ------------
## ------------ ASSESSMENT MODEL ------------
## catches in it 1_scs0 2021 
##  1e-05 
## !warning: Report.sso appears to be early version from before Hessian was estimated.
##           equilibrium yield estimates not included in output.
## ----------------- ADVICE -----------------
## -----------------  PIL  -----------------
## [1] 0
## ############################################################
## -                   Year:  45 , Season:  1 
## ############################################################
## ************ OPERATING MODEL***************************
## ------------ BIOLOGICAL OM ------------
## -----------------ASPG-----------
## ------------ FLEETS OM ------------
## [1] &quot;~~~~~~~~~~ EFFORT ~~~~~~~~&quot;
## [1] &quot;INT&quot;
## [1] &quot;~~~~~~ UPDATE CATCH ~~~~~~&quot;
## [1] &quot;~~~~~~~~~~ PRICE ~~~~~~~~~~&quot;
## [1] &quot;INT&quot;
## [1] &quot;****************************** CAPITAL ******************************&quot;
## [1] &quot;INT&quot;
## ------------ COVARS OM ------------
## ************ MANAGEMENT PROCEDURE ****************************
## ----------- OBSERVATION MODEL ------------
## ------------ ASSESSMENT MODEL ------------
## catches in it 1_scs0 2022 
##  1e-05 
## !warning: Report.sso appears to be early version from before Hessian was estimated.
##           equilibrium yield estimates not included in output.
## ----------------- ADVICE -----------------
## -----------------  PIL  -----------------
## [1] 0
## ############################################################
## -                   Year:  46 , Season:  1 
## ############################################################
## ************ OPERATING MODEL***************************
## ------------ BIOLOGICAL OM ------------
## -----------------ASPG-----------
## ------------ FLEETS OM ------------
## [1] &quot;~~~~~~~~~~ EFFORT ~~~~~~~~&quot;
## [1] &quot;INT&quot;
## [1] &quot;~~~~~~ UPDATE CATCH ~~~~~~&quot;
## [1] &quot;~~~~~~~~~~ PRICE ~~~~~~~~~~&quot;
## [1] &quot;INT&quot;
## [1] &quot;****************************** CAPITAL ******************************&quot;
## [1] &quot;INT&quot;
## ------------ COVARS OM ------------
## ************ MANAGEMENT PROCEDURE ****************************
## ----------- OBSERVATION MODEL ------------
## ------------ ASSESSMENT MODEL ------------
## catches in it 1_scs0 2023 
##  1e-05 
## !warning: Report.sso appears to be early version from before Hessian was estimated.
##           equilibrium yield estimates not included in output.
## ----------------- ADVICE -----------------
## -----------------  PIL  -----------------
## [1] 0
## ############################################################
## -                   Year:  47 , Season:  1 
## ############################################################
## ************ OPERATING MODEL***************************
## ------------ BIOLOGICAL OM ------------
## -----------------ASPG-----------
## ------------ FLEETS OM ------------
## [1] &quot;~~~~~~~~~~ EFFORT ~~~~~~~~&quot;
## [1] &quot;INT&quot;
## [1] &quot;~~~~~~ UPDATE CATCH ~~~~~~&quot;
## [1] &quot;~~~~~~~~~~ PRICE ~~~~~~~~~~&quot;
## [1] &quot;INT&quot;
## [1] &quot;****************************** CAPITAL ******************************&quot;
## [1] &quot;INT&quot;
## ------------ COVARS OM ------------
## ************ MANAGEMENT PROCEDURE ****************************
## ----------- OBSERVATION MODEL ------------
## ------------ ASSESSMENT MODEL ------------
## catches in it 1_scs0 2024 
##  1e-05 
## !warning: Report.sso appears to be early version from before Hessian was estimated.
##           equilibrium yield estimates not included in output.
## ----------------- ADVICE -----------------
## -----------------  PIL  -----------------
## [1] 0.12
## ############################################################
## -                   Year:  48 , Season:  1 
## ############################################################
## ************ OPERATING MODEL***************************
## ------------ BIOLOGICAL OM ------------
## -----------------ASPG-----------
## ------------ FLEETS OM ------------
## [1] &quot;~~~~~~~~~~ EFFORT ~~~~~~~~&quot;
## [1] &quot;INT&quot;
## [1] &quot;~~~~~~ UPDATE CATCH ~~~~~~&quot;
## [1] &quot;~~~~~~~~~~ PRICE ~~~~~~~~~~&quot;
## [1] &quot;INT&quot;
## [1] &quot;****************************** CAPITAL ******************************&quot;
## [1] &quot;INT&quot;
## ------------ COVARS OM ------------
## ************ MANAGEMENT PROCEDURE ****************************
## ----------- OBSERVATION MODEL ------------
## ------------ ASSESSMENT MODEL ------------
## catches in it 1_scs0 2025 
##  48898.21 
## !warning: Report.sso appears to be early version from before Hessian was estimated.
##           equilibrium yield estimates not included in output.
## ----------------- ADVICE -----------------
## -----------------  PIL  -----------------
## [1] 0.12
## ############################################################
## -                   Year:  49 , Season:  1 
## ############################################################
## ************ OPERATING MODEL***************************
## ------------ BIOLOGICAL OM ------------
## -----------------ASPG-----------
## ------------ FLEETS OM ------------
## [1] &quot;~~~~~~~~~~ EFFORT ~~~~~~~~&quot;
## [1] &quot;INT&quot;
## [1] &quot;~~~~~~ UPDATE CATCH ~~~~~~&quot;
## [1] &quot;~~~~~~~~~~ PRICE ~~~~~~~~~~&quot;
## [1] &quot;INT&quot;
## [1] &quot;****************************** CAPITAL ******************************&quot;
## [1] &quot;INT&quot;
## ------------ COVARS OM ------------
## ************ MANAGEMENT PROCEDURE ****************************
## ----------- OBSERVATION MODEL ------------
## ------------ ASSESSMENT MODEL ------------
## catches in it 1_scs0 2026 
##  65991.45 
## !warning: Report.sso appears to be early version from before Hessian was estimated.
##           equilibrium yield estimates not included in output.
## ----------------- ADVICE -----------------
## -----------------  PIL  -----------------
## [1] 0.12
## ############################################################
## -                   Year:  50 , Season:  1 
## ############################################################
## ************ OPERATING MODEL***************************
## ------------ BIOLOGICAL OM ------------
## -----------------ASPG-----------
## ------------ FLEETS OM ------------
## [1] &quot;~~~~~~~~~~ EFFORT ~~~~~~~~&quot;
## [1] &quot;INT&quot;
## [1] &quot;~~~~~~ UPDATE CATCH ~~~~~~&quot;
## [1] &quot;~~~~~~~~~~ PRICE ~~~~~~~~~~&quot;
## [1] &quot;INT&quot;
## [1] &quot;****************************** CAPITAL ******************************&quot;
## [1] &quot;INT&quot;
## ------------ COVARS OM ------------
## ************ MANAGEMENT PROCEDURE ****************************
## ----------- OBSERVATION MODEL ------------
## ------------ ASSESSMENT MODEL ------------
## catches in it 1_scs0 2027 
##  69616.29 
## !warning: Report.sso appears to be early version from before Hessian was estimated.
##           equilibrium yield estimates not included in output.
## ----------------- ADVICE -----------------
## -----------------  PIL  -----------------
## [1] 0.12
## ############################################################
## -                   Year:  51 , Season:  1 
## ############################################################
## ************ OPERATING MODEL***************************
## ------------ BIOLOGICAL OM ------------
## -----------------ASPG-----------
## ------------ FLEETS OM ------------
## [1] &quot;~~~~~~~~~~ EFFORT ~~~~~~~~&quot;
## [1] &quot;INT&quot;
## [1] &quot;~~~~~~ UPDATE CATCH ~~~~~~&quot;
## [1] &quot;~~~~~~~~~~ PRICE ~~~~~~~~~~&quot;
## [1] &quot;INT&quot;
## [1] &quot;****************************** CAPITAL ******************************&quot;
## [1] &quot;INT&quot;
## ------------ COVARS OM ------------</code></pre>
</div>
<div id="flbeia-output" class="section level1">
<h1>FLBEIA output</h1>
<pre class="r"><code># - stock summary
s0_bio &lt;- bioSum(s0, scenario=&quot;hcrICES_assSS3&quot;)
plotbioSum( s0_bio, Blim=PIL_ref.pts[[&quot;Blim&quot;]], Bpa=PIL_ref.pts[[&quot;Bpa&quot;]], 
            proj.yr=main.ctrl$sim.years[[&quot;initial&quot;]])</code></pre>
<p><img src="FLBEIA_Incorporating_SS3assessment_MP_files/figure-html/sumPlot-1.png" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code># - fleet summary
s0$fleets &lt;- setUnitsNA(s0$fleets)
s0_flt &lt;- fltSum(s0, scenario=&quot;hcrICES_assSS3&quot;)
plotfltSum( s0_flt, proj.yr=main.ctrl$sim.years[[&quot;initial&quot;]])</code></pre>
<p><img src="FLBEIA_Incorporating_SS3assessment_MP_files/figure-html/sumPlot-2.png" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code># - risk summary
s0_risk  &lt;- riskSum( s0, Bpa = c(PIL=PIL_ref.pts[[&quot;Bpa&quot;]]), Blim = c(PIL=PIL_ref.pts[[&quot;Blim&quot;]]), 
                     Prflim = c(INT = NA), 
                     scenario=&quot;hcrICES_assSS3&quot;)
s0_risk$year &lt;- as.numeric(ac(s0_risk$year))
ggplot( data=s0_risk, aes(x=year, y=value, color=scenario)) +
  geom_line() +
  facet_wrap(~indicator, scales=&quot;free&quot;) +
  facet_grid(indicator ~ .) +
  geom_vline(xintercept = main.ctrl$sim.years[[&quot;initial&quot;]]-1, linetype = &quot;longdash&quot;)+
  theme_bw()+
  theme(text=element_text(size=15),
        title=element_text(size=15,face=&quot;bold&quot;),
        strip.text=element_text(size=15))+
  ylab(&quot;Risk&quot;)</code></pre>
<p><img src="FLBEIA_Incorporating_SS3assessment_MP_files/figure-html/sumPlot-3.png" width="672" style="display: block; margin: auto;" /></p>
<p>We can also compare the last assessed stock (MP) with the real one (OM). In principle, in FLBEIA, the assessment results are only saved for the last assessed year. However, in this case we have kept track of the assessment results (ssb, rec and fbar) in every projection year (see next section for more details).</p>
<div id="assessment-fit---convergence-issues" class="section level2">
<h2>Assessment fit - convergence issues</h2>
<p>To check if the assessment fitting has converged, we have stored convergence values in the covars object.</p>
<pre class="r"><code># Number of years in which assessment did not converged
sum(s0$covars$conv&gt;0.001,na.rm=TRUE) </code></pre>
<pre><code>## [1] 0</code></pre>
<pre class="r"><code># In case there are, let&#39;s see which one(s):
dimnames(s0$covars$conv)$year[!is.na(s0$covars$conv) &amp; s0$covars$conv&gt;0.01]</code></pre>
<pre><code>## character(0)</code></pre>
<p>In case that we have lack of convergence in any of the projection years, then the projections should be repeated until we get an output where all the assessments converged.</p>
<p>We can also check the assessment consistency between years (e.g. checking if there are retrospective pattens).</p>
<pre class="r"><code># Management Procedure - perceived
stk.MP &lt;- s0$covars[c(&quot;rec&quot;, &quot;fbar&quot;, &quot;ssb&quot;, &quot;qs&quot;)]
nyr &lt;- dim(stk.MP$ssb)[1]
stk.MP &lt;- lapply( stk.MP, function(x) x[-nyr,])

# Operating Model - &quot;real&quot;
stk.OM &lt;- list()
stk.OM$ssb &lt;- ssb(s0$biols$PIL)
stk.OM$rec &lt;- s0$biols$PIL@n[1,]
#! +++ CREO QUE HAY UN LAG DE UN ANNO EN LO QUE GUARDADMOS!!!! +++
#!     --&gt; COMPROBAR

stk.OM$indices &lt;- stk.MP$qs*NA
stk.OM$indices[1,] &lt;- quantSums(s0$indices$PIL$AcousticNumberAtAge@index)
stk.OM$indices[2,] &lt;- s0$indices$PIL$DEPM@index</code></pre>
<pre class="r"><code>dat &lt;- stk.MP[c(&quot;ssb&quot;, &quot;fbar&quot;, &quot;rec&quot;)]

dat &lt;- do.call(&quot;rbind&quot;, lapply(seq_along(dat), function(i,x) {
  cbind(as.data.frame(x[[i]]),indicator=names(x)[i])
}, x=dat))

ggplot( dat, aes( year, data, col = factor(assess.year), fill = factor(assess.year)))+
  facet_wrap(~indicator, scales = &quot;free&quot;, ncol = 2) +
  stat_summary(fun.y = median,
               fun.ymin = function(x) quantile(x,0.05), 
               fun.ymax = function(x) quantile(x,0.95), 
               geom = &quot;ribbon&quot;,alpha=0.1,col=NA) +
  stat_summary(fun.y = median,
               geom = &quot;line&quot;,size=1) + 
  ggtitle(&quot;retros&quot;)</code></pre>
<p><img src="FLBEIA_Incorporating_SS3assessment_MP_files/figure-html/assRetros-1.png" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>dat &lt;- as.data.frame(sweep( stk.MP$ssb, 2, stk.OM$ssb, &quot;/&quot;))
ggplot(dat,aes(year,data))+facet_wrap(~assess.year)+
  stat_summary(fun.y = median,
               fun.ymin = function(x) quantile(x,0.05), 
               fun.ymax = function(x) quantile(x,0.95), 
               geom = &quot;ribbon&quot;,alpha=0.2,col=NA) +
  stat_summary(fun.y = median,
               geom = &quot;line&quot;,size=1)+
  geom_hline(yintercept = 1)+geom_vline(xintercept = main.ctrl$sim.years[[&quot;initial&quot;]]-1)+
  ggtitle(&quot;&quot;)+ylim(0.7,1.3)+ylab(&quot;estim ssb/real ssb&quot;)</code></pre>
<p><img src="FLBEIA_Incorporating_SS3assessment_MP_files/figure-html/assPerf-1.png" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>dat &lt;- as.data.frame(sweep( stk.MP$rec, 2, stk.OM$rec, &quot;/&quot;))
ggplot(dat,aes(year,data))+facet_wrap(~assess.year)+
  stat_summary(fun.y = median,
               fun.ymin = function(x) quantile(x,0.05), 
               fun.ymax = function(x) quantile(x,0.95), 
               geom = &quot;ribbon&quot;,alpha=0.2,col=NA) +
  stat_summary(fun.y = median,
               geom = &quot;line&quot;,size=1)+
  geom_hline(yintercept = 1)+geom_vline(xintercept = main.ctrl$sim.years[[&quot;initial&quot;]]-1)+
  ggtitle(&quot;&quot;)+ylim(0.7,1.3)+ylab(&quot;estim rec/real rec&quot;)</code></pre>
<p><img src="FLBEIA_Incorporating_SS3assessment_MP_files/figure-html/assPerf-2.png" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>dat &lt;- as.data.frame(stk.MP$qs)
ggplot(dat,aes(year,data,col=factor(qs),fill=factor(qs)))+#facet_wrap(~assess.year)+
  stat_summary(fun.y = median,
               fun.ymin = function(x) quantile(x,0.05), 
               fun.ymax = function(x) quantile(x,0.95), 
               geom = &quot;ribbon&quot;,alpha=0.1,col=NA) +
  stat_summary(fun.y = median,
               geom = &quot;line&quot;,size=1)+
  geom_hline(yintercept = 1)+geom_vline(xintercept = main.ctrl$sim.years[[&quot;initial&quot;]]-1)+
  ggtitle(&quot;&quot;)+ylab(&quot;qs&quot;)</code></pre>
<p><img src="FLBEIA_Incorporating_SS3assessment_MP_files/figure-html/assPerf-3.png" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>dat &lt;- as.data.frame(stk.OM$indices)
ggplot(dat,aes(year,data,col=factor(qs),fill=factor(qs)))+facet_wrap(~qs,scales=&quot;free&quot;)+
  stat_summary(fun.y = median,
               fun.ymin = function(x) quantile(x,0.05), 
               fun.ymax = function(x) quantile(x,0.95), 
               geom = &quot;ribbon&quot;,alpha=0.1,col=NA) +
  stat_summary(fun.y = median,
               geom = &quot;line&quot;,size=1)+
  geom_hline(yintercept = 1)+geom_vline(xintercept = main.ctrl$sim.years[[&quot;initial&quot;]]-1)+
  ggtitle(&quot;&quot;)+ylab(&quot;generated indices&quot;)</code></pre>
<p><img src="FLBEIA_Incorporating_SS3assessment_MP_files/figure-html/assPerf-4.png" width="672" style="display: block; margin: auto;" /></p>
<pre class="r"><code>dat &lt;- as.data.frame(s0$covars$sel)
ggplot(dat,aes(age,data,col=factor(year),fill=factor(year)))+facet_wrap(~unit)+
  stat_summary(fun.y = median,
               fun.ymin = function(x) quantile(x,0.05), 
               fun.ymax = function(x) quantile(x,0.95), 
               geom = &quot;ribbon&quot;,alpha=0.1,col=NA) +
  stat_summary(fun.y = median,
               geom = &quot;line&quot;,size=1)+ 
  ggtitle(&quot;&quot;)+ylab(&quot;selectivities by block&quot;)</code></pre>
<p><img src="FLBEIA_Incorporating_SS3assessment_MP_files/figure-html/assPerf-5.png" width="672" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="more-information" class="section level1">
<h1>More information</h1>
<ul>
<li>You can submit bug reports, questions or suggestions on this tutorial at <a href="https://github.com/flr/doc/issues" class="uri">https://github.com/flr/doc/issues</a>.</li>
<li>Or send a pull request to <a href="https://github.com/flr/doc/" class="uri">https://github.com/flr/doc/</a></li>
<li>For more information on the FLR Project for Quantitative Fisheries Science in R, visit the FLR webpage, <a href="http://flr-project.org" class="uri">http://flr-project.org</a>.</li>
<li>You can submit bug reports, questions or suggestions specific to <strong>FLBEIA</strong> to <a href="mailto:flbeia@azti.es" class="email">flbeia@azti.es</a>.</li>
</ul>
<div id="software-versions" class="section level2">
<h2>Software Versions</h2>
<ul>
<li>R version 4.0.0 (2020-04-24)</li>
<li>FLCore: 2.6.15</li>
<li>FLBEIA: 1.15.4</li>
<li>FLFleet: 2.6.1</li>
<li>FLash: 2.5.11</li>
<li>FLAssess: 2.6.3</li>
<li>ggplotFL: 2.6.7.9006</li>
<li>ggplot2: 3.3.0</li>
<li>r4ss: 1.36.1</li>
<li>reshape2: 1.4.4</li>
<li><strong>Compiled</strong>: Wed May 27 11:59:15 2020</li>
</ul>
</div>
<div id="license" class="section level2">
<h2>License</h2>
<p>This document is licensed under the <a href="https://creativecommons.org/licenses/by-sa/4.0">Creative Commons Attribution-ShareAlike 4.0 International</a> license.</p>
</div>
<div id="author-information" class="section level2">
<h2>Author information</h2>
<p><strong>Leire Citores</strong>. AZTI, Marine Research Unit. Txatxarramendi Ugartea z/g, 48395, Sukarrieta, Basque Country, Spain. <a href="https://www.azti.es/" class="uri">https://www.azti.es/</a>.</p>
<p><strong>Sonia Sanchez</strong>. AZTI, Marine Research Unit. Herrera Kaia, Portualdea z/g, 20110, Pasaia, Gipuzkoa, Spain. <a href="https://www.azti.es/" class="uri">https://www.azti.es/</a>.</p>
<p><strong>FLBEIA team</strong>. AZTI. Marine Reserach Unit. Txatxarramendi Ugartea z/g, 48395, Sukarrieta, Basque Country, Spain. <a href="http://flbeia.azti.es/" class="uri">http://flbeia.azti.es/</a>. <strong>Mail</strong> <a href="mailto:flbeia@azti.es" class="email">flbeia@azti.es</a></p>
</div>
</div>
<div id="references" class="section level1 unnumbered">
<h1 class="unnumbered">References</h1>
<div id="refs" class="references hanging-indent">
<div id="ref-garcia2017">
<p>Garcia, Dorleta, Sonia Sánchez, Raúl Prellezo, Agurtzane Urtizberea, and Marga Andrés. 2017. “FLBEIA: A Simulation Model to Conduct Bio-Economic Evaluation of Fisheries Management Strategies.” <em>SoftwareX</em> 6: 141–47.</p>
</div>
<div id="ref-ices2009">
<p>ICES. 2009. “Chair’s Report of the Workshop on the Form of Advice (Wkform).” ICES CM 2009/ACOM:53.</p>
</div>
<div id="ref-wghansa2018">
<p>———. 2018. “Report of the Working Group on Southern Horse Mackerel, Anchovy and Sardine (Wghansa).” ICES CM 2018/ACOM:17.</p>
</div>
<div id="ref-wksarmp2019">
<p>———. 2019. “Workshop on the Iberian Sardine Management and Recovery Plan (Wksarmp).” <em>ICES Scientific Reports</em> 1 (18): 125.</p>
</div>
<div id="ref-methot2012">
<p>Methot, Richard D. 2012. <em>User Manual for Stock Synthesis Model Version 3.24f</em>.</p>
</div>
<div id="ref-methot2013">
<p>Methot, Richard D., and Chantell R. Wetzel. 2013. “Stock Synthesis: A Biological and Statistical Framework for Fish Stock Assessment and Fishery Management.” <em>Fisheries Research</em> 142: 86–99.</p>
</div>
</div>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
